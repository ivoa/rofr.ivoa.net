<?xml version="1.0"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:jacoco="antlib:org.jacoco.ant" name="common">

  <dirname  property="common.basedir" file="${ant.file.common}"/>
  <property name="lib.dir" value="${basedir}/lib"/>
  <property name="src.dir" value="${basedir}/src"/>
  <property name="main.dir" value="${src.dir}/main"/>
  <property name="test.dir" value="${src.dir}/test"/>
  <property name="java.dir" value="${main.dir}/java"/>
  <property name="resources.dir" value="${main.dir}/resources"/>
  <property name="webapp.dir" value="${main.dir}/webapp"/>
  <property name="scripts.dir" value="${main.dir}/scripts"/>
  <property name="test.java.dir" value="${test.dir}/java"/>
  <property name="test.resources.dir" value="${test.dir}/resources"/>
  <property name="target.dir" value="${basedir}/target"/>
  <property name="classes.dir" value="${target.dir}/classes"/>
  <property name="test.classes.dir" value="${target.dir}/test-classes"/>
  <property name="test.reports.dir" value="${target.dir}/test-reports"/>

  <property name="overwrite.deploy" value="false"/>

  <!-- Use team developer's area for ivy cache and local repository -->
  <condition property="ivy.default.ivy.user.dir" 
	     value="/data/rofr/devel/${user.name}/ivy">
    <isfileselected file="/data/rofr/devel/${user.name}/ivy">
      <type type="dir"/>
    </isfileselected>
  </condition>

    <taskdef uri="antlib:org.jacoco.ant" resource="org/jacoco/ant/antlib.xml">
        <classpath path="antlib/jacocoant.jar" />
        <classpath path="antlib/jacoco-core.jar"/>
        <classpath path="antlib/jacoco-report.jar"/>
        <classpath path="antlib/jacoco-agent.jar"/>
        <classpath path="antlib/asm.jar"/>
        <classpath path="antlib/asm-commons.jar"/>
        <classpath path="antlib/asm-tree.jar"/>
    </taskdef>

  <target name="initialize"
	  description="Initialize build state">
    <mkdir dir="${lib.dir}"/>
    <mkdir dir="${lib.dir}/compile"/>
    <mkdir dir="${lib.dir}/provided"/>
    <mkdir dir="${lib.dir}/runtime"/>
    <mkdir dir="${test.java.dir}"/>
    <mkdir dir="${target.dir}"/>
    <mkdir dir="${target.dir}/classes"/>
    <mkdir dir="${target.dir}/test-classes"/>
    <mkdir dir="${target.dir}/test-reports"/>
  </target>

  <target name="resolve"
	  description="Initialize build state"
	  depends="ivy-init, jacoco-init">
    <ivy:retrieve pattern="${lib.dir}/[conf]/[artifact](-[classifier]).[ext]"/>
  </target>

  <target name="compile"
	  description="Compile source code"
	  depends="initialize, resolve">
    <javac srcdir="${java.dir}"
	   destdir="${classes.dir}"
	   debug="true"
	   includeantruntime="false">
      <classpath>
	<fileset dir="${lib.dir}/compile"/>
	<fileset dir="${lib.dir}/provided"/>
      </classpath>
    </javac>
  </target>

  <target name="test-compile"
	  description="Compile unit test source code"
	  depends="compile">
    <javac srcdir="${test.java.dir}"
	   destdir="${test.classes.dir}"
	   debug="true"
	   includeantruntime="false">
      <classpath>
	<pathelement location="${classes.dir}"/>
	<fileset dir="${lib.dir}/compile"/>
	<fileset dir="${lib.dir}/provided"/>
	<fileset dir="${lib.dir}/test"/>
      </classpath>
    </javac>
  </target>

  <target name="test"
	  description="Run unit tests"
	  depends="test-compile">
      <jacoco:coverage>
          <junit printsummary="yes" fork="yes"
                 dir="${basedir}"
           haltonfailure="yes">
              <classpath>
                <pathelement path="${classes.dir}"/>
                <pathelement path="${test.classes.dir}"/>
                <fileset dir="${lib.dir}/runtime"/>
                <fileset dir="${lib.dir}/test"/>
                <pathelement path="${test.resources.dir}"/>
                <pathelement path="${resources.dir}"/>
              </classpath>

              <formatter type="plain"/>

              <batchtest fork="yes" todir="${test.reports.dir}">
                <fileset dir="${test.java.dir}">
                  <exclude name="**/TestHarvestValidater.java"/>
                </fileset>
              </batchtest>
            </junit>
      </jacoco:coverage>
      <jacoco:report>
          <structure name="${ant.project.name}">
              <classfiles>
                  <fileset dir="${classes.dir}"/>
              </classfiles>
              <sourcefiles encoding="UTF-8">
                  <fileset dir="src"/>
              </sourcefiles>
          </structure>

          <html destdir="${target.dir}/test-reports"/>

      </jacoco:report>
  </target>

  <target name="package"
	  description="Package code for distribution"
	  depends="package-jar,package-zip">
  </target>

  <target name="package-jar"
	  description="Package code for distribution"
	  depends="test">
    <jar destfile="${target.dir}/${ant.project.name}.jar">
      <fileset dir="${classes.dir}"/>
      <fileset dir="${resources.dir}" erroronmissingdir="false"/>
    </jar>
  </target>

  <target name="package-uberjar"
          description="Package an uberjar (this target is only relevant for console Java SE applications)"
          depends="test">
      <jar destfile="${target.dir}/${ant.project.name}-uber.jar"
           manifest="${src.dir}/META-INF/MANIFEST.MF"
      >
          <fileset dir="${classes.dir}"/>
          <fileset dir="${resources.dir}" erroronmissingdir="false"/>
          <zipgroupfileset dir="${lib.dir}/runtime" includes="**/*.jar"/>
    </jar>
  </target>

  <target name="package-zip"
	  depends="package-jar">
    <zip destfile="${target.dir}/${ant.project.name}.zip">
      <zipfileset dir="${scripts.dir}" 
		  prefix="${ant.project.name}/bin"
		  filemode="755"
                  erroronmissingdir="false"
                  />
      <zipfileset dir="${target.dir}" 
		  prefix="${ant.project.name}/lib" 
		  includes="${ant.project.name}.jar"/>
      <zipfileset dir="${lib.dir}/runtime" 
		  prefix="${ant.project.name}/lib" 
		  includes="*.jar"/>
      <zipfileset dir="${basedir}" 
		  prefix="${ant.project.name}" 
		  includes="LICENSE*"/>
    </zip>
  </target>

  <target name="install"
	  description="Install into local dependency repository"
	  depends="package">
    <ivy:deliver deliverpattern="${target.dir}/[module]-[revision](-[classifier]).[ext]"/>
    <ivy:publish resolver="local" 
		 artifactspattern="${target.dir}/[module].[ext]"
		 srcivypattern="${target.dir}/[module]-[revision](-[classifier]).[ext]"/>
  </target>

  <target name="deploy"
	  description="Install into shared dependency repository"
	  depends="package">
    <ivy:deliver deliverpattern="${target.dir}/[module]-[revision](-[classifier]).[ext]"
		 status="${ivy.status}"
		 pubrevision="${ivy.deliver.revision}"/>
    <ivy:publish resolver="shared" 
		 artifactspattern="${target.dir}/[module].[ext]"
		 srcivypattern="${target.dir}/[module]-[revision](-[classifier]).[ext]"
		 overwrite="${overwrite.deploy}"/>
  </target>

  <target name="clean"
	  description="Remove all files generated by the previous build">
    <delete dir="${lib.dir}"/>
    <delete dir="${target.dir}"/>
    <delete dir="${basedir}/antlib"/>
    <delete>
     <fileset dir="${basedir}">
        <include name="build.xml.*.log"/>
     </fileset>
    </delete>
    <delete file="${basedir}/.ant-targets-build.xml"/>
  </target>

  <property name="maven.central.url" value="https://repo1.maven.org/maven2" />

    <available file="antlib/ivy.jar" type="file" property="have.ivy.jar"/>
    <available file="antlib/jacocoant.jar" type="file" property="have.jacocoant.jar"/>
    <available file="antlib/jacoco-core.jar" type="file" property="have.jacoco-core.jar"/>
    <available file="antlib/jacoco-report.jar" type="file" property="have.jacoco-report.jar"/>
    <available file="antlib/jacoco-agent.jar" type="file" property="have.jacoco-agent.jar"/>
    <available file="antlib/asm.jar" type="file" property="have.asm.jar"/>
    <available file="antlib/asm-commons.jar" type="file" property="have.asm-commons.jar"/>
    <available file="antlib/asm-tree.jar" type="file" property="have.asm-tree.jar"/>

  <target name="ivy-check-taskdefs">
    <condition property="have.ivy.taskdefs">
      <typefound uri="antlib:org.apache.ivy.ant" name="publish"/>
    </condition>
  </target>

  <target name="ivy-init" 
	  depends="ivy-download, ivy-check-taskdefs" 
	  unless="have.ivy.taskdefs">
    <path id="ivy.class.path">
      <fileset dir="antlib">
	<include name="*.jar"/>
      </fileset>
    </path>
    <taskdef resource="org/apache/ivy/ant/antlib.xml"
	     uri="antlib:org.apache.ivy.ant"
	     classpathref="ivy.class.path" />
    <ivy:settings file="${common.basedir}/ivysettings.xml"/>
  </target>
 
  <target name="ivy-download" 
	  unless="have.ivy.jar">
    <mkdir dir="antlib" />
    <get src="${maven.central.url}/org/apache/ivy/ivy/2.5.0/ivy-2.5.0.jar"
	 dest="antlib/ivy.jar" usetimestamp="true" verbose="true" />
  </target>

    <target name="jacoco-init"
            depends="asm-init, jacocoant-download">
        <path id="jacoco.class.path">
            <fileset dir="antlib">
                <include name="*.jar"/>
            </fileset>
        </path>
        <taskdef resource="org/jacoco/ant/antlib.xml"
                 uri="antlib:org.jacoco.ant"
                 classpathref="jacoco.class.path" />
    </target>

    <target name="jacocoant-download"
            unless="have.jacocoant.jar, have.jacoco-core.jar, have.jacoco-report.jar, have.jacoco-agent.jar">
        <mkdir dir="antlib" />
        <get src="${maven.central.url}/org/jacoco/org.jacoco.ant/0.8.14/org.jacoco.ant-0.8.14.jar"
             dest="antlib/jacocoant.jar" usetimestamp="true" verbose="true" />
        <get src="${maven.central.url}/org/jacoco/org.jacoco.core/0.8.14/org.jacoco.core-0.8.14.jar"
             dest="antlib/jacoco-core.jar" usetimestamp="true" verbose="true" />
        <get src="${maven.central.url}/org/jacoco/org.jacoco.report/0.8.14/org.jacoco.report-0.8.14.jar"
             dest="antlib/jacoco-report.jar" usetimestamp="true" verbose="true" />
        <get src="${maven.central.url}/org/jacoco/org.jacoco.agent/0.8.14/org.jacoco.agent-0.8.14.jar"
             dest="antlib/jacoco-agent.jar" usetimestamp="true" verbose="true" />
    </target>

    <target name="asm-init"
            depends="asm-download">
        <path id="jacoco.class.path">
            <fileset dir="antlib">
                <include name="*.jar"/>
            </fileset>
        </path>
        <taskdef resource="org/jacoco/ant/antlib.xml"
                 uri="antlib:org.jacoco.ant"
                 classpathref="jacoco.class.path" />
    </target>

    <target name="asm-download"
            unless="have.asm.jar, have.asm-commons.jar, have.asm-tree.jar">
        <mkdir dir="antlib" />
        <get src="${maven.central.url}/org/ow2/asm/asm/9.9/asm-9.9.jar"
             dest="antlib/asm.jar" usetimestamp="true" verbose="true" />
        <get src="${maven.central.url}/org/ow2/asm/asm-commons/9.9/asm-commons-9.9.jar"
             dest="antlib/asm-commons.jar" usetimestamp="true" verbose="true" />
        <get src="${maven.central.url}/org/ow2/asm/asm-tree/9.9/asm-tree-9.9.jar"
             dest="antlib/asm-tree.jar" usetimestamp="true" verbose="true" />
    </target>
</project>

